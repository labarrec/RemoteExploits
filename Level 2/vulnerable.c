
#include <stdio.h>
#include <errno.h>
#include <sys/socket.h>
#include <resolv.h>
#include <arpa/inet.h>
#include <signal.h>
#include <string.h>
#include <sys/types.h>
#include <stdlib.h>
#include <netinet/in.h>

#define MY_PORT                 9999
#define MAX_NAME_SIZE           128
#define MAX_PASSWORD_SIZE       2048
#define CHILD_PROCESS_ID        0

/*-- Prototypes --*/
void handleClientConnection(int clientFileDescriptor);
void hashPassword(char * password);
void flushStream(int socketDescriptor);

/*-- Main Method --*/
int main(int Count, char *Strings[]) {
    
    int socketFileDescriptor;
    struct sockaddr_in socketAddress;
    
    /*---Create streaming socket---*/
    if ( (socketFileDescriptor = socket(AF_INET, SOCK_STREAM, 0)) < 0 ) {
        perror("Socket");
        exit(errno);
    }
    
    /*---Initialize address/port structure---*/
    bzero(&socketAddress, sizeof(socketAddress));
    socketAddress.sin_family = AF_INET;
    socketAddress.sin_port = htons(MY_PORT);
    socketAddress.sin_addr.s_addr = INADDR_ANY;
    
    /*---Assign a port number to the socket---*/
    if ( bind(socketFileDescriptor, (struct sockaddr*)&socketAddress, sizeof(socketAddress)) != 0 ) {
        perror("socket--bind");
        exit(errno);
    }
    
    /*---Make it a "listening socket"---*/
    if ( listen(socketFileDescriptor, 20) != 0 ) {
        perror("socket--listen");
        exit(errno);
    }
    
    /*-- Server Loop --*/
    while (1) {
        int clientFileDescriptor;
        struct sockaddr_in clientAddress;
        int clientAddressLength=sizeof(clientAddress);
        
        /*-- accept, handle, and close a connection --*/
        clientFileDescriptor = accept(socketFileDescriptor, (struct sockaddr*)&clientAddress, &clientAddressLength);
        handleClientConnection(clientFileDescriptor);
        close(clientFileDescriptor);
    }
    
    /*--- Clean up ---*/
    close(socketFileDescriptor);
    return 0;
}

void handleClientConnection(int clientFileDescriptor) {
    
    char * welcomeMessage = "\n公安秘密サーバーにようこそ！";
    char * loginPrompt = "\nログインID: ";
    char * passwordPrompt = "パスワード: ";
    char * closingMessage = "恐れ入れますが、アクセッス許可された。警察は連絡された。\n\n";

    /*--- Send Banner ---*/
    send(clientFileDescriptor, welcomeMessage, strlen(welcomeMessage), 0);
    
    /*-- Send First Name Prompt ---*/
    send(clientFileDescriptor, loginPrompt, strlen(loginPrompt), 0);
    
    /*-- Receive First Name --*/
    char loginBuffer[MAX_NAME_SIZE];
    bzero(loginBuffer, MAX_NAME_SIZE);
    recv(clientFileDescriptor, &loginBuffer, sizeof(loginBuffer), 0);
    flushStream(clientFileDescriptor);

    /*-- Send Last Name Prompt --*/
    send(clientFileDescriptor, passwordPrompt, strlen(passwordPrompt), 0);
    
    /*-- Receive Last Name --*/
    char passwordBuffer[MAX_NAME_SIZE];
    bzero(passwordBuffer, MAX_NAME_SIZE);
    recv(clientFileDescriptor, &passwordBuffer, sizeof(passwordBuffer), 0);
    flushStream(clientFileDescriptor);

    /*-- "Hash" the passowrd.  Contains vulnerability --*/
    hashPassword(loginBuffer);
    
    /*-- Send Closing Message --*/
    send(clientFileDescriptor, closingMessage, strlen(closingMessage), 0);
    printf("Sent closing message.\n");
}

void hashPassword(char * password) {
    char hashedPassword[90];
    bzero(hashedPassword, 90);
    strcpy(hashedPassword, password);
}

void flushStream(int socketDescriptor) {
    char temporaryBuffer[1024];
    while (recv(socketDescriptor, &temporaryBuffer, 1024, MSG_DONTWAIT) > 0) {}
}

