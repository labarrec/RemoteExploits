
#include <stdio.h>
#include <errno.h>
#include <sys/socket.h>
#include <resolv.h>
#include <arpa/inet.h>
#include <signal.h>
#include <string.h>
#include <sys/types.h>
#include <stdlib.h>
#include <netinet/in.h>

#define MY_PORT                 9999
#define MAX_NAME_SIZE           128
#define MAX_PASSWORD_SIZE       2048
#define CHILD_PROCESS_ID        0

/*-- Prototypes --*/
void handleClientConnection(int clientFileDescriptor);
void hashPassword(char * password);

/*-- Main Method --*/
int main(int Count, char *Strings[]) {
    
    int socketFileDescriptor;
    struct sockaddr_in socketAddress;
    
    /*---Create streaming socket---*/
    if ( (socketFileDescriptor = socket(AF_INET, SOCK_STREAM, 0)) < 0 ) {
        perror("Socket");
        exit(errno);
    }
    
    /*---Initialize address/port structure---*/
    bzero(&socketAddress, sizeof(socketAddress));
    socketAddress.sin_family = AF_INET;
    socketAddress.sin_port = htons(MY_PORT);
    socketAddress.sin_addr.s_addr = INADDR_ANY;
    
    /*---Assign a port number to the socket---*/
    if ( bind(socketFileDescriptor, (struct sockaddr*)&socketAddress, sizeof(socketAddress)) != 0 ) {
        perror("socket--bind");
        exit(errno);
    }
    
    /*---Make it a "listening socket"---*/
    if ( listen(socketFileDescriptor, 20) != 0 ) {
        perror("socket--listen");
        exit(errno);
    }
    
    /*-- Server Loop --*/
    while (1) {
        int clientFileDescriptor;
        struct sockaddr_in clientAddress;
        int clientAddressLength=sizeof(clientAddress);
        
        /*-- accept, handle, and close a connection --*/
        clientFileDescriptor = accept(socketFileDescriptor, (struct sockaddr*)&clientAddress, &clientAddressLength);
        handleClientConnection(clientFileDescriptor);
        close(clientFileDescriptor);
    }
    
    /*--- Clean up ---*/
    close(socketFileDescriptor);
    return 0;
}

void handleClientConnection(int clientFileDescriptor) {
    
    char hashedPassword[16];
    
    char * welcomeMessage = "\nWelcome to the Cool Kids Club!";
    char * firstNamePrompt = "\nPlease enter your First Name: ";
    char * lastNamePrompt = "Please enter your Last Name: ";
    char * passwordPrompt = "Please enter the super secret password: ";
    char * closingMessage = "Sorry.  You're not cool enough for the Cool Kids Club\n\n";

    /*--- Send Banner ---*/
    send(clientFileDescriptor, welcomeMessage, strlen(welcomeMessage), 0);
    
    /*-- Send First Name Prompt ---*/
    send(clientFileDescriptor, firstNamePrompt, strlen(firstNamePrompt), 0);
    
    /*-- Receive First Name --*/
    char firstNameBuffer[MAX_NAME_SIZE];
    bzero(firstNameBuffer, MAX_NAME_SIZE);
    recv(clientFileDescriptor, &firstNameBuffer, sizeof(firstNameBuffer), 0);
    firstNameBuffer[strlen(firstNameBuffer) - 1] = '\0';
    
    /*-- Send Last Name Prompt --*/
    send(clientFileDescriptor, lastNamePrompt, strlen(lastNamePrompt), 0);
    
    /*-- Receive Last Name --*/
    char lastNamebuffer[MAX_NAME_SIZE];
    bzero(lastNamebuffer, MAX_NAME_SIZE);
    recv(clientFileDescriptor, &lastNamebuffer, sizeof(lastNamebuffer), 0);
    lastNamebuffer[strlen(lastNamebuffer) - 1] = '\0';
    
    /*-- Send Secret Password Prompt --*/
    send(clientFileDescriptor, passwordPrompt, strlen(passwordPrompt), 0);
    
    /*-- Receive Secret Password Prompt --*/
    char passwordBuffer[MAX_PASSWORD_SIZE];
    bzero(passwordBuffer, MAX_PASSWORD_SIZE);
    recv(clientFileDescriptor, &passwordBuffer, sizeof(passwordBuffer), 0);
    passwordBuffer[strlen(passwordBuffer) - 1] = '\0';
    
    /*-- "Hash" the passowrd.  Contains vulnerability --*/
    hashPassword(passwordBuffer);
    
    /*-- Send Closing Message --*/
    send(clientFileDescriptor, closingMessage, strlen(closingMessage), 0);
}

void hashPassword(char * password) {
    char hashedPassword[1536];
    bzero(hashedPassword, 1536);
    strcpy(hashedPassword, password);
}


